<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Generador Banco Moodle</title>
<style>
body { font-family: Arial; max-width: 900px; margin: 30px auto; }
textarea, input { width: 100%; margin: 6px 0; padding: 6px; }
button { padding: 6px 12px; margin: 5px 5px 5px 0; cursor: pointer; }
.pregunta { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 6px; }
.opcion { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
#preview { white-space: pre-wrap; background: #f4f4f4; padding: 10px; height: 250px; overflow:auto; }
h2 { margin-bottom: 5px; }
.small { font-size: 14px; color: #555; margin-bottom: 20px; }
</style>
</head>
<body>

<h2>Generador de Banco de Preguntas Moodle</h2>
<div class="small">Herramienta simple para exportar preguntas Multiple Choice en formato XML</div>

<div id="contenedor"></div>

<button onclick="agregarPregunta()">Agregar Pregunta</button>
<button onclick="generarXML()">Descargar XML</button>

<h3>Vista previa XML</h3>
<div id="preview"></div>

<script>

let preguntas = [];

function agregarPregunta() {

  preguntas.push({
    nombre: "",
    enunciado: "",
    feedback: "",
    opciones: [
      {texto:"", correcta:false},
      {texto:"", correcta:false}
    ]
  });

  render();
}

function agregarOpcion(i){
  preguntas[i].opciones.push({texto:"", correcta:false});
  render();
}

function eliminarPregunta(i){
  preguntas.splice(i,1);
  render();
}

function duplicarPregunta(i){
  const copia = JSON.parse(JSON.stringify(preguntas[i]));
  preguntas.splice(i + 1, 0, copia);
  render();
}

function render(){

  const cont = document.getElementById("contenedor");
  cont.innerHTML = "";

  preguntas.forEach((p,i)=>{

    cont.innerHTML += `
    <div class="pregunta">
      <h3>Pregunta ${i+1}</h3>

      <input placeholder="Nombre interno (no visible para el alumno)" 
        value="${p.nombre}"
        onchange="preguntas[${i}].nombre=this.value">

      <textarea placeholder="Enunciado"
        onchange="preguntas[${i}].enunciado=this.value">${p.enunciado}</textarea>

      <textarea placeholder="Retroalimentación general"
        onchange="preguntas[${i}].feedback=this.value">${p.feedback}</textarea>

      <strong>Opciones:</strong>

      ${p.opciones.map((o,j)=>`
        <div class="opcion">
          <input type="checkbox"
            ${o.correcta ? "checked" : ""}
            onchange="preguntas[${i}].opciones[${j}].correcta=this.checked">
          <input placeholder="Texto opción"
            value="${o.texto}"
            onchange="preguntas[${i}].opciones[${j}].texto=this.value">
        </div>
      `).join("")}

      <button onclick="agregarOpcion(${i})">Agregar opción</button>
      <button onclick="duplicarPregunta(${i})">Duplicar pregunta</button>
      <button onclick="eliminarPregunta(${i})">Eliminar pregunta</button>
    </div>
    `;
  });
}

function generarXML(){

  let preguntasXML = "";

  preguntas.forEach(p=>{

    const correctas = p.opciones.filter(o=>o.correcta).length;
    const single = correctas === 1 ? "true" : "false";
    const fraccion = correctas > 0 ? (100 / correctas) : 0;

    let respuestasXML = "";

    p.opciones.forEach(o=>{
      const fraction = o.correcta ? fraccion : 0;

      respuestasXML += `
<answer fraction="${fraction}" format="html">
<text><![CDATA[ ${o.texto} ]]></text>
</answer>`;
    });

    preguntasXML += `
<question type="multichoice">
<name><text>${p.nombre}</text></name>
<questiontext format="html">
<text><![CDATA[ <p>${p.enunciado}</p> ]]></text>
</questiontext>
<generalfeedback format="html">
<text><![CDATA[ ${p.feedback} ]]></text>
</generalfeedback>
<defaultgrade>1.0000000</defaultgrade>
<penalty>0.0000000</penalty>
<hidden>0</hidden>
<single>${single}</single>
<shuffleanswers>true</shuffleanswers>
<answernumbering>abc</answernumbering>
${respuestasXML}
</question>`;
  });

  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<quiz>
${preguntasXML}
</quiz>`;

  document.getElementById("preview").textContent = xml;

  const blob = new Blob([xml], {type:"text/xml"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "banco_moodle.xml";
  link.click();
}

agregarPregunta();

</script>

</body>
</html>
