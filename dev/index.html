<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Generador XML Moodle</title>

<style>
* { box-sizing: border-box; }

body{
    font-family: Arial, sans-serif;
    background:#f4f6f9;
    margin:0;
    padding:20px;
}

h1{
    text-align:center;
    margin-bottom:10px;
}

.status-bar{
    position:sticky;
    top:0;
    background:#ffffff;
    padding:10px;
    margin-bottom:15px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
    display:flex;
    justify-content:space-between;
    align-items:center;
    z-index:10;
}

.top-buttons{
    text-align:center;
    margin-bottom:20px;
}

button{
    padding:8px 14px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    margin:3px;
}

button:disabled{
    opacity:0.5;
    cursor:not-allowed;
}

.primary{ background:#1976d2; color:white; }
.success{ background:#2e7d32; color:white; }
.warning{ background:#f9a825; color:white; }
.danger{ background:#c62828; color:white; }
.secondary{ background:#607d8b; color:white; }

#preguntas{
    max-height:500px;
    overflow-y:auto;
    padding-right:10px;
}

.pregunta{
    background:white;
    margin-bottom:15px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
    overflow:hidden;
    transition:all 0.3s ease;
}

.pregunta-header{
    padding:10px;
    background:#e3eaf2;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.pregunta-header span:first-child{
    display:inline-block;
    max-width:calc(100% - 25px);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    vertical-align: middle;
}

.pregunta-body{
    padding:15px;
    overflow:hidden;
    transition:max-height 0.35s ease, opacity 0.25s ease;
    max-height:3000px;
    opacity:1;
}

.pregunta.colapsada .pregunta-body{
    max-height:0;
    opacity:0;
    padding-top:0;
    padding-bottom:0;
}

.completa{ border-left:6px solid #2e7d32; }
.incompleta{ border-left:6px solid #c62828; }

input[type="text"], input[type="number"], textarea{
    width:100%;
    padding:8px;
    margin-bottom:8px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:14px;
}

select{
    padding:5px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:14px;
}

textarea{ resize:vertical; }

.opcion{
    display:flex;
    align-items:center;
    gap:6px;
    margin-bottom:6px;
}

.opcion input[type="text"]{
    flex:1;
    margin-bottom:0;
}

.pregunta-buttons{
    margin-top:10px;
    text-align:right;
}

.fila-horizontal{
    display:flex;
    gap:10px;
    align-items:flex-start;
}

.fila-horizontal input[type="text"]{
    flex:2;
}

.fila-horizontal select{
    flex:1;
    max-width:180px;
}

/* Configuración essay en fila horizontal */
.essay-config{
    display:flex;
    gap:10px;
    align-items:flex-start;
    margin-bottom:8px;
}

.essay-config .campo-essay{
    display:flex;
    flex-direction:column;
    flex:1;
}

.essay-config label{
    font-size:13px;
    margin-bottom:4px;
}

.essay-config input{
    padding:8px;
    font-size:14px;
    border-radius:6px;
    border:1px solid #ccc;
    width:100%;
    box-sizing:border-box;
}
</style>
</head>
<body>

<h1>Generador XML Moodle</h1>

<div class="status-bar">
    <div id="contador">Completas: 0 | Incompletas: 0</div>
    <button class="success" id="btnDescargar" onclick="descargarXML()" disabled>
        Descargar XML
    </button>
</div>

<div class="top-buttons">
    <button class="primary" onclick="agregarPregunta()">Agregar Pregunta</button>
    <button class="secondary" onclick="document.getElementById('fileInput').click()">Cargar XML</button>
    <button class="warning" onclick="resetFormulario()">Reset</button>
    <input type="file" id="fileInput" accept=".xml" style="display:none" onchange="cargarXML(event)">
</div>

<div id="preguntas"></div>

<script>
function scrollAlFinal(){
    const contenedor=document.getElementById("preguntas");
    contenedor.scrollTop=contenedor.scrollHeight;
}

function crearOpcion(texto="",correcta=false){
    const div=document.createElement("div");
    div.className="opcion";

    const checkbox=document.createElement("input");
    checkbox.type="checkbox";
    checkbox.checked=correcta;
    checkbox.onchange=validarTodo;

    const input=document.createElement("input");
    input.type="text";
    input.placeholder="Texto de opción";
    input.value=texto;
    input.oninput=validarTodo;

    const btn=document.createElement("button");
    btn.textContent="X";
    btn.className="danger";
    btn.onclick=()=>{ div.remove(); validarTodo(); };

    div.appendChild(checkbox);
    div.appendChild(input);
    div.appendChild(btn);

    return div;
}

function actualizarTitulo(wrapper,enunciado){
    const texto = enunciado.value.trim();
    const span = wrapper.querySelector(".pregunta-header span:first-child");

    // Limita a 50 caracteres + "…"
    const resumen = texto.length > 150 ? texto.substr(0,150) + "…" : texto;
    span.textContent = resumen !== "" ? resumen : "Pregunta";
}

function agregarPregunta(datos=null){
    const contenedor=document.getElementById("preguntas");

    const wrapper=document.createElement("div");
    wrapper.className="pregunta incompleta";

    const header=document.createElement("div");
    header.className="pregunta-header";
    header.innerHTML=`<span>Pregunta</span><span>▼</span>`;

    const body=document.createElement("div");
    body.className="pregunta-body";

    header.onclick=()=>{
        wrapper.classList.toggle("colapsada");
        header.querySelector("span:last-child").textContent =
            wrapper.classList.contains("colapsada") ? "▶" : "▼";
    };

    const filaSuperior=document.createElement("div");
    filaSuperior.className="fila-horizontal";

    const nombre=document.createElement("input");
    nombre.type="text";
    nombre.placeholder="Nombre interno (no visible para el alumno)";
    nombre.value=datos?.nombre||"";
    nombre.oninput=validarTodo;

    const tipoSelect=document.createElement("select");
    tipoSelect.innerHTML=`
        <option value="multichoice">Opción múltiple</option>
        <option value="essay">Desarrollo (Essay)</option>
    `;
    tipoSelect.value=datos?.tipo||"multichoice";
    tipoSelect.style.height = "33px";

    filaSuperior.appendChild(nombre);
    filaSuperior.appendChild(tipoSelect);

    const enunciado=document.createElement("textarea");
    enunciado.placeholder="Enunciado";
    enunciado.value=datos?.enunciado||"";
    enunciado.oninput=()=>{ actualizarTitulo(wrapper,enunciado); validarTodo(); };
    enunciado.style.height = "120px";

    const retro=document.createElement("textarea");
    retro.placeholder="Retroalimentación";
    retro.value=datos?.retro||"";

    const opcionesDiv=document.createElement("div");
    const essayDiv=document.createElement("div");
    essayDiv.style.display="none";

    /* CONFIGURACIÓN ESSAY EN FILA HORIZONTAL */
    const configDiv = document.createElement("div");
    configDiv.className = "essay-config";

    const campoPuntaje = document.createElement("div");
    campoPuntaje.className = "campo-essay";
    const labelPuntaje = document.createElement("label");
    labelPuntaje.textContent = "Puntaje:";
    const puntaje = document.createElement("input");
    puntaje.type = "number";
    puntaje.value = datos?.puntaje || 1;
    puntaje.min = 0.1;
    puntaje.step = 0.1;
    puntaje.oninput = validarTodo;
    labelPuntaje.appendChild(puntaje);
    campoPuntaje.appendChild(labelPuntaje);

    const campoLineas = document.createElement("div");
    campoLineas.className = "campo-essay";
    const labelLineas = document.createElement("label");
    labelLineas.textContent = "Líneas:";
    const lineas = document.createElement("input");
    lineas.type = "number";
    lineas.value = datos?.lineas || 15;
    labelLineas.appendChild(lineas);
    campoLineas.appendChild(labelLineas);

    const campoAdjuntos = document.createElement("div");
    campoAdjuntos.className = "campo-essay";
    const labelAdjuntos = document.createElement("label");
    labelAdjuntos.textContent = "Adjuntos:";
    const adjuntos = document.createElement("input");
    adjuntos.type = "number";
    adjuntos.value = datos?.adjuntos || 0;
    labelAdjuntos.appendChild(adjuntos);
    campoAdjuntos.appendChild(labelAdjuntos);

    configDiv.appendChild(campoPuntaje);
    configDiv.appendChild(campoLineas);
    configDiv.appendChild(campoAdjuntos);

    const graderinfo=document.createElement("textarea");
    graderinfo.placeholder="Información para el corrector";
    graderinfo.value=datos?.graderinfo||"";

    essayDiv.appendChild(configDiv);
    essayDiv.appendChild(graderinfo);

    if(datos?.opciones){
        datos.opciones.forEach(o=>{
            opcionesDiv.appendChild(crearOpcion(o.texto,o.correcta));
        });
    }else{
        opcionesDiv.appendChild(crearOpcion());
        opcionesDiv.appendChild(crearOpcion());
    }

    const btnAdd=document.createElement("button");
    btnAdd.textContent="Agregar opción";
    btnAdd.className="secondary";
    btnAdd.onclick=()=>opcionesDiv.appendChild(crearOpcion());

    tipoSelect.onchange=()=>{
        if(tipoSelect.value==="essay"){
            opcionesDiv.innerHTML="";
            opcionesDiv.style.display="none";
            btnAdd.style.display="none";
            essayDiv.style.display="block";
        }else{
            essayDiv.style.display="none";
            opcionesDiv.style.display="block";
            btnAdd.style.display="inline-block";
            if(opcionesDiv.children.length<2){
                opcionesDiv.appendChild(crearOpcion());
                opcionesDiv.appendChild(crearOpcion());
            }
        }
        validarTodo();
    };

    if(tipoSelect.value==="essay"){
        tipoSelect.onchange();
    }

    const botonesDiv=document.createElement("div");
    botonesDiv.className="pregunta-buttons";

    const btnDuplicar=document.createElement("button");
    btnDuplicar.textContent="Duplicar";
    btnDuplicar.className="primary";
    btnDuplicar.onclick=()=>{
        const datos=extraerDatos(wrapper);
        agregarPregunta(datos);
    };

    const btnEliminar=document.createElement("button");
    btnEliminar.textContent="Eliminar";
    btnEliminar.className="danger";
    btnEliminar.onclick=()=>{wrapper.remove(); validarTodo();};

    botonesDiv.appendChild(btnDuplicar);
    botonesDiv.appendChild(btnEliminar);

    body.appendChild(filaSuperior);
    body.appendChild(enunciado);
    body.appendChild(retro);
    body.appendChild(opcionesDiv);
    body.appendChild(btnAdd);
    body.appendChild(essayDiv);
    body.appendChild(botonesDiv);

    wrapper.appendChild(header);
    wrapper.appendChild(body);

    contenedor.appendChild(wrapper);

    actualizarTitulo(wrapper, enunciado); // ✅ Actualiza resumen
    enunciado.focus();
    scrollAlFinal();
    validarTodo();

    return wrapper; // devuelve wrapper para usar en cargarXML
}

function extraerDatos(wrapper){
    const tipo=wrapper.querySelector("select").value;
    const textareas=wrapper.querySelectorAll("textarea");

    const nombre=wrapper.querySelector("input[type='text']").value;
    const enunciado=textareas[0].value;
    const retro=textareas[1].value;

    const data={tipo,nombre,enunciado,retro};

    if(tipo==="multichoice"){
        const opciones=[];
        wrapper.querySelectorAll(".opcion").forEach(o=>{
            opciones.push({
                texto:o.querySelector("input[type=text]").value,
                correcta:o.querySelector("input[type=checkbox]").checked
            });
        });
        data.opciones=opciones;
    }else{
        const inputs=wrapper.querySelectorAll(".essay-config input[type=number]");
        data.puntaje=parseFloat(inputs[0].value)||1;
        data.lineas=parseInt(inputs[1].value)||15;
        data.adjuntos=parseInt(inputs[2].value)||0;
        data.graderinfo=textareas[2]?.value||"";
    }

    return data;
}

function validarPregunta(wrapper){
    const data=extraerDatos(wrapper);

    if(data.tipo==="essay"){
        return data.enunciado.trim()!=="" && data.puntaje>0;
    }

    const opciones=data.opciones;
    let validas=0;
    let correcta=false;

    opciones.forEach(o=>{
        if(o.texto.trim()!=="") validas++;
        if(o.correcta && o.texto.trim()!=="") correcta=true;
    });

    return data.enunciado.trim()!=="" && validas>=2 && correcta;
}

function validarTodo(){
    const preguntas=document.querySelectorAll(".pregunta");
    let completas=0;
    let incompletas=0;

    preguntas.forEach(p=>{
        if(validarPregunta(p)){
            completas++;
            p.classList.add("completa");
            p.classList.remove("incompleta");
        }else{
            incompletas++;
            p.classList.add("incompleta");
            p.classList.remove("completa");
        }
    });

    document.getElementById("contador").textContent=
        `Completas: ${completas} | Incompletas: ${incompletas}`;

    document.getElementById("btnDescargar").disabled=
        incompletas>0 || preguntas.length===0;
}

function resetFormulario(){
    if(confirm("Se perderá todo el contenido actual. ¿Continuar?")){
        document.getElementById("preguntas").innerHTML="";
        validarTodo();
    }
}

function cargarXML(event){
    const file=event.target.files[0];
    if(!file) return;

    if(!confirm("Se reemplazará el contenido actual. ¿Continuar?")){
        event.target.value="";
        return;
    }

    const reader=new FileReader();
    reader.onload=function(e){
        const parser=new DOMParser();
        const xmlDoc=parser.parseFromString(e.target.result,"text/xml");

        document.getElementById("preguntas").innerHTML="";

        xmlDoc.querySelectorAll("question").forEach(q=>{
            const tipo=q.getAttribute("type")||"multichoice";
            const nombre=q.querySelector("name text")?.textContent||"";
            const enunciado=q.querySelector("questiontext text")?.textContent||"";
            const retro=q.querySelector("generalfeedback text")?.textContent||"";

            let wrapper;

            if(tipo==="essay"){
                wrapper = agregarPregunta({
                    tipo:"essay",
                    nombre,
                    enunciado,
                    retro,
                    puntaje:parseFloat(q.querySelector("defaultgrade")?.textContent)||1,
                    lineas:parseInt(q.querySelector("responsefieldlines")?.textContent)||15,
                    adjuntos:parseInt(q.querySelector("attachments")?.textContent)||0,
                    graderinfo:q.querySelector("graderinfo text")?.textContent||""
                });
            }else{
                const opciones=[];
                q.querySelectorAll("answer").forEach(a=>{
                    opciones.push({
                        texto:a.querySelector("text").textContent,
                        correcta:a.getAttribute("fraction")==100
                    });
                });

                wrapper = agregarPregunta({tipo:"multichoice",nombre,enunciado,retro,opciones});
            }

            // Actualiza resumen visible
            const textarea = wrapper.querySelector("textarea");
            actualizarTitulo(wrapper, textarea);
        });

        validarTodo();
    };

    reader.readAsText(file);
    event.target.value="";
}

function descargarXML(){
    let xml='<?xml version="1.0" encoding="UTF-8"?><quiz>';

    document.querySelectorAll(".pregunta").forEach(p=>{
        const data=extraerDatos(p);

        if(data.tipo==="essay"){
            xml+=`<question type="essay">`;
            xml+=`<name><text>${data.nombre}</text></name>`;
            xml+=`<questiontext format="html"><text><![CDATA[${data.enunciado}]]></text></questiontext>`;
            xml+=`<defaultgrade>${data.puntaje}</defaultgrade>`;
            xml+=`<responseformat>editor</responseformat>`;
            xml+=`<responsefieldlines>${data.lineas}</responsefieldlines>`;
            xml+=`<attachments>${data.adjuntos}</attachments>`;
            xml+=`<attachmentsrequired>0</attachmentsrequired>`;
            xml+=`<graderinfo format="html"><text><![CDATA[${data.graderinfo}]]></text></graderinfo>`;
            xml+=`<generalfeedback format="html"><text><![CDATA[${data.retro}]]></text></generalfeedback>`;
            xml+=`</question>`;
        }else{
            xml+=`<question type="multichoice">`;
            xml+=`<name><text>${data.nombre}</text></name>`;
            xml+=`<questiontext format="html"><text><![CDATA[${data.enunciado}]]></text></questiontext>`;
            xml+=`<generalfeedback><text><![CDATA[${data.retro}]]></text></generalfeedback>`;
            xml+=`<single>false</single>`;

            data.opciones.forEach(o=>{
                xml+=`<answer fraction="${o.correcta?100:0}"><text><![CDATA[${o.texto}]]></text></answer>`;
            });

            xml+=`</question>`;
        }
    });

    xml+="</quiz>";

    const blob=new Blob([xml],{type:"text/xml"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="preguntas.xml";
    a.click();
}
</script>
</body>
</html>
